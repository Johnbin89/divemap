# Alembic Migration System Setup

This document describes the complete setup and usage of Alembic for database migrations in the Divemap project.

## Overview

Alembic is the official migration tool for SQLAlchemy and provides version control for database schema changes. This setup ensures that database migrations run automatically before the FastAPI backend starts.

## Files Created

### Configuration Files
- `alembic.ini` - Main Alembic configuration
- `migrations/env.py` - Environment configuration for migrations
- `migrations/script.py.mako` - Template for generating migration files

### Migration Files
- `migrations/versions/0001_initial.py` - Initial database schema migration

### Scripts
- `run_migrations.py` - Python script to run migrations with database health checks
- `create_migration.py` - Script to generate new migrations
- `run_migrations_docker.sh` - Shell script for Docker environment

### Documentation
- `MIGRATIONS_README.md` - User guide for migrations
- `ALEMBIC_SETUP.md` - This setup documentation

## Setup Process

### 1. Install Alembic
```bash
cd backend
source divemap_venv/bin/activate
pip install alembic==1.16.4
```

### 2. Configure Alembic
- Created `alembic.ini` with database URL and settings
- Created `migrations/env.py` with SQLAlchemy model imports
- Added `get_database_url()` function to `app/database.py`

### 3. Create Initial Migration
- Created `migrations/versions/0001_initial.py` representing current database state
- Marked existing database as up-to-date with `alembic stamp head`

### 4. Fix Python Path Issues
Due to asdf Python setup, added PYTHONPATH export:
```bash
export PYTHONPATH="/home/kargig/src/divemap/backend/divemap_venv/lib/python3.11/site-packages:$PYTHONPATH"
```

## Usage

### Development Environment

#### Run Migrations Manually
```bash
cd backend
source divemap_venv/bin/activate
export PYTHONPATH="/home/kargig/src/divemap/backend/divemap_venv/lib/python3.11/site-packages:$PYTHONPATH"

# Run migrations
python run_migrations.py

# Or use alembic directly
alembic upgrade head
```

#### Create New Migration
```bash
# Auto-generate from model changes
python create_migration.py "Add new table"

# Or use alembic directly
alembic revision --autogenerate -m "Add new table"
```

#### Check Migration Status
```bash
# Check current version
alembic current

# Check history
alembic history

# Check pending migrations
alembic heads
```

### Docker Environment

#### Automatic Migration
Migrations run automatically when the Docker container starts:
```bash
docker-compose up backend
```

The Dockerfile includes:
```dockerfile
# Run migrations and then start the application
CMD ["sh", "-c", "python run_migrations.py && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"]
```

#### Manual Migration in Docker
```bash
# Run migrations in running container
docker-compose exec backend python run_migrations.py

# Or use the shell script
docker-compose exec backend ./run_migrations_docker.sh
```

## Migration Workflow

### 1. Modify SQLAlchemy Models
Edit models in `app/models.py`:
```python
class NewTable(Base):
    __tablename__ = "new_table"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(255), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
```

### 2. Generate Migration
```bash
python create_migration.py "Add new table"
```

### 3. Review Generated Migration
Check the generated file in `migrations/versions/`:
```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('new_table',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(length=255), nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_new_table_id'), 'new_table', ['id'], unique=False)
    # ### end Alembic commands ###
```

### 4. Test Migration
```bash
# Apply migration
alembic upgrade head

# Test application
# Rollback if needed
alembic downgrade -1
```

### 5. Apply Migration
```bash
# Apply to development
alembic upgrade head

# Apply to production (after backup)
alembic upgrade head
```

## Database Health Checks

The `run_migrations.py` script includes:

### Database Availability Check
- Waits for database to be available
- Retries up to 30 times with 2-second delays
- Provides clear status messages

### Migration Execution
- Runs `alembic upgrade head`
- Captures and displays output
- Handles errors gracefully

### Error Handling
- Database connection failures
- Migration execution failures
- Missing Alembic installation

## Environment Variables

### Required
- `DATABASE_URL` - Database connection string
- Default: `mysql+pymysql://divemap_user:divemap_password@localhost:3306/divemap`

### Python Path (for asdf)
- `PYTHONPATH` - Set to virtual environment site-packages
- Required for proper module imports

## Troubleshooting

### Common Issues

#### 1. Module Not Found Errors
**Problem:** `ModuleNotFoundError: No module named 'sqlalchemy'`
**Solution:** Set PYTHONPATH for asdf environments:
```bash
export PYTHONPATH="/home/kargig/src/divemap/backend/divemap_venv/lib/python3.11/site-packages:$PYTHONPATH"
```

#### 2. Database Connection Failures
**Problem:** Database not available during migration
**Solution:** The script includes automatic retry logic with health checks

#### 3. Table Already Exists
**Problem:** `Table 'users' already exists`
**Solution:** Mark database as up-to-date:
```bash
alembic stamp head
```

#### 4. Migration Template Missing
**Problem:** `FileNotFoundError: script.py.mako`
**Solution:** Ensure `migrations/script.py.mako` exists

### Debugging Commands

#### Check Alembic Status
```bash
alembic current
alembic history
alembic heads
```

#### Check Database Connection
```bash
python -c "from app.database import engine; print(engine.connect())"
```

#### Check Python Path
```bash
python -c "import sys; print('\\n'.join(sys.path))"
```

## Best Practices

### 1. Always Test Migrations
```bash
# Test on development first
alembic upgrade head
# Test application functionality
alembic downgrade -1
```

### 2. Backup Before Production
```bash
# Always backup before production migrations
mysqldump -u user -p database > backup.sql
alembic upgrade head
```

### 3. Use Descriptive Migration Names
```bash
# Good
python create_migration.py "Add user preferences table"

# Bad
python create_migration.py "fix"
```

### 4. Review Generated Migrations
Always review auto-generated migrations before applying them, especially for:
- Data type changes
- Index modifications
- Foreign key changes

### 5. Handle Dependencies
```python
# In migration file
revision = '0002'
down_revision = '0001'  # Depends on previous migration
```

## Integration with CI/CD

### Pre-deployment Checks
```bash
# Check migration status
alembic current

# Run migrations
python run_migrations.py

# Verify application starts
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### Docker Integration
The Dockerfile automatically runs migrations before starting the application, ensuring the database schema is always up-to-date.

## Security Considerations

### 1. Database Credentials
- Use environment variables for database credentials
- Never hardcode credentials in migration files
- Use different credentials for development and production

### 2. Migration Permissions
- Ensure database user has appropriate permissions
- Test migrations with limited permissions
- Use read-only connections when possible for verification

### 3. Backup Strategy
- Always backup before running migrations
- Test rollback procedures
- Keep migration history for audit purposes

## Performance Considerations

### 1. Large Tables
- Use `IF EXISTS` checks for large tables
- Consider downtime for major schema changes
- Use online DDL when possible

### 2. Index Management
- Drop indexes before bulk operations
- Recreate indexes after data migration
- Monitor index usage and performance

### 3. Transaction Management
- Use appropriate transaction isolation levels
- Consider breaking large migrations into smaller ones
- Test migration performance on production-like data

## Conclusion

This Alembic setup provides:

1. **Automatic Migration Execution** - Migrations run before application startup
2. **Database Health Checks** - Ensures database is available before migrations
3. **Environment Compatibility** - Works with asdf Python environments
4. **Comprehensive Documentation** - Clear usage instructions and troubleshooting
5. **Docker Integration** - Seamless deployment with automatic migrations
6. **Error Handling** - Robust error handling and recovery procedures

The system ensures that database schema changes are version-controlled, tested, and applied consistently across all environments. 